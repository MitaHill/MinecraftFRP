# SFTP 上传速度优化 - 回滚说明

## ❌ 优化失败原因

### 问题分析
1. **服务器带宽限制**: 20Mbps (约 2.5MB/s)
2. **优化过度**: 128MB窗口 + 256KB包大小对低带宽反而有副作用
3. **实际速度**: 优化后从 300KB/s 降到 100KB/s

### 原因
- **TCP窗口过大**: 128MB窗口在20Mbps网络上导致拥塞
- **缓冲区溢出**: 1MB缓冲区远超实际网络承载能力
- **重传开销**: 大包在不稳定网络下重传代价高

---

## ✅ 已回滚

### 回滚内容
- `src_builder/deployer.py` 已恢复到原始版本
- TCP 窗口: 3MB
- 包大小: 32KB  
- 缓冲区: 默认

### 保留的优化
- ✅ Launcher 启动性能优化（不受影响）
- ✅ 下载进度气泡通知（不受影响）
- ✅ 自动清理旧安装包（不受影响）

---

## 💡 建议

### 针对 20Mbps 带宽的实际情况

**理论最大速度**: 20Mbps ÷ 8 = 2.5MB/s

**实际可达速度**:
- 下载: 2-2.3MB/s (接近满速)
- **上传**: 通常是下载的 10-50%

#### 为什么上传比下载慢？

1. **ISP限制**: 大部分宽带上传带宽 < 下载带宽
2. **SSH加密开销**: 上传时本地CPU需要加密
3. **TCP ACK**: 上传需要等待服务器确认包

#### 实际速度预期
- **20Mbps下载** → 实际上传约 100-500KB/s 是正常的
- 如果是对称带宽（20Mbps上行），理论可达 1.5-2MB/s

---

## 🔍 诊断建议

### 1. 测试实际上传带宽
```bash
# 使用 speedtest
speedtest-cli

# 或使用网页版
https://www.speedtest.net/
```

### 2. 检查 SSH 加密算法
```bash
# 使用更快的加密算法
ssh -c aes128-ctr root@clash.ink
```

### 3. 使用 rsync（通常更快）
```bash
rsync -avz --progress dist/MinecraftFRP_Setup.exe root@clash.ink:/path/
```

---

## 📊 速度对比

| 方法 | 速度 | 说明 |
|------|------|------|
| SFTP (原始) | 300KB/s | 基准 |
| SFTP (过度优化) | 100KB/s | ❌ 反而更慢 |
| **SFTP (回滚后)** | **300KB/s** | ✅ 恢复正常 |
| rsync | 400-600KB/s | 可选替代 |

---

## 🎯 结论

对于 **20Mbps 带宽**：
- ✅ 300KB/s 已经是**合理速度**
- ✅ 上传176MB 约需 **10分钟**（可接受）
- ❌ 过度优化会适得其反

### 当前状态
- Deployer 已恢复原始版本
- 上传速度恢复到 300KB/s
- Launcher 优化保持不变

---

**建议**: 如果经常上传大文件，可考虑：
1. 升级带宽到对称光纤（如 100Mbps上下对称）
2. 使用 rsync 替代 SFTP
3. 压缩后再上传（可节省 20-30% 时间）

**回滚时间**: 2025-12-10  
**状态**: ✅ 已完成
