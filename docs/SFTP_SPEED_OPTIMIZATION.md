# SFTP 上传速度优化文档

## 🚀 优化内容

### 优化前
- **窗口大小**: 3MB
- **包大小**: 32KB
- **缓冲区**: 默认（~32KB）
- **实际速度**: ~300KB/s

### 优化后
- **窗口大小**: 128MB（提升 42倍）
- **包大小**: 256KB（提升 8倍）
- **缓冲区**: 1MB（提升 32倍）
- **预期速度**: 2-10MB/s（取决于网络）

---

## 🔧 主要改进

### 1. TCP 窗口大小优化
```python
# 旧: 3MB
transport.window_size = 3 * 1024 * 1024

# 新: 128MB（极限优化）
transport.window_size = 128 * 1024 * 1024
```
**作用**: 允许更多数据在确认前发送，减少往返延迟

### 2. 数据包大小优化
```python
# 旧: 32KB
transport.default_max_packet_size = 32768

# 新: 256KB
transport.default_max_packet_size = 256 * 1024
```
**作用**: 减少包头开销，提升有效带宽利用率

### 3. 自定义缓冲区上传
```python
# 使用 1MB 缓冲区（远大于默认 32KB）
chunk_size = 1024 * 1024
```
**作用**: 减少系统调用次数，提升 I/O 效率

### 4. 其他优化
- ✅ 启用 SSH 压缩（`compress=True`）
- ✅ 禁用不必要的密钥查找
- ✅ 增加超时时间（避免大文件传输中断）
- ✅ 优化重新密钥间隔

---

## 📊 性能对比

| 参数 | 优化前 | 优化后 | 提升倍数 |
|------|-------|-------|---------|
| TCP 窗口 | 3MB | 128MB | **42倍** |
| 包大小 | 32KB | 256KB | **8倍** |
| 缓冲区 | 32KB | 1MB | **32倍** |
| **预期速度** | 300KB/s | 2-10MB/s | **7-33倍** |

---

## 💡 速度影响因素

### 网络带宽
- **100Mbps**: 理论最大 12.5MB/s，实际可达 8-10MB/s
- **1Gbps**: 理论最大 125MB/s，实际可达 50-80MB/s

### 服务器性能
- 磁盘 I/O 速度
- CPU 加密性能
- 网络接口卡速度

### 网络延迟
- 局域网: <1ms，速度最快
- 同城: 1-10ms，速度较快
- 跨省: 20-50ms，速度中等
- 国际: 100-300ms，速度受限

---

## 🧪 测试建议

```bash
# 重新构建并上传，观察速度
python build.py --channel dev --upload -u "优化SFTP上传速度（目标2MB/s+）"
```

### 期望输出
```
Uploading: 21.28MB / 176.66MB (12.05%) - Speed: 2.35MB/s
Uploading: 56.78MB / 176.66MB (32.14%) - Speed: 3.12MB/s
Uploading: 102.45MB / 176.66MB (58.00%) - Speed: 2.87MB/s
...
OK: Executable uploaded in 65.3s (avg 2.71MB/s)
```

---

## 🛠️ 进一步优化（如果仍然慢）

### 1. 检查网络瓶颈
```bash
# 测试到服务器的带宽
iperf3 -c clash.ink
```

### 2. 使用更快的传输协议
```bash
# rsync 通常比 SFTP 快 20-50%
rsync -avz --progress dist/MinecraftFRP_Setup.exe root@clash.ink:/path/
```

### 3. 使用多线程上传（分片）
```python
# 将大文件分成多个小文件，并行上传
# 适用于非常大的文件（>500MB）
```

### 4. 服务器端优化
```bash
# SSH 服务器配置优化（需要 root 权限）
# /etc/ssh/sshd_config
MaxSessions 10
MaxStartups 10:30:60
```

---

## ⚠️ 注意事项

1. **内存占用**: 128MB 窗口会增加内存使用（约 256MB）
2. **网络稳定性**: 大窗口对不稳定网络可能适得其反
3. **服务器限制**: 某些服务器可能限制单连接带宽

### 如果速度反而变慢
降低参数：
```python
transport.window_size = 64 * 1024 * 1024  # 64MB
transport.default_max_packet_size = 128 * 1024  # 128KB
```

---

## 📝 日志与监控

优化后的上传会显示实时速度：
```
Uploading: 21.28MB / 176.66MB (12.05%) - Speed: 2.35MB/s
```

如果速度未达到预期，检查：
1. 本地网络上传带宽
2. 服务器下载带宽
3. 网络延迟（`ping clash.ink`）
4. 服务器磁盘速度

---

**优化时间**: 2025-12-10  
**预期提升**: 7-33倍（300KB/s → 2-10MB/s）  
**状态**: ✅ 已实施，等待实测验证
